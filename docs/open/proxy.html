<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Proxy | 码步鱼</title>
    <meta name="description" content="java node nodejs typescript k8s golang python react native vue vue3 flutter uni-app taro 后端 前端 app 小程序 运维 微服务 架构 微信 博客 笔记">
    <link rel="stylesheet" href="/assets/style.5034d561.css">
    <link rel="modulepreload" href="/assets/Home.c9aa88e2.js">
    <link rel="modulepreload" href="/assets/app.9f9f1749.js">
    <link rel="modulepreload" href="/assets/open_proxy.md.55480c0e.lean.js">
    <link rel="modulepreload" href="/assets/app.9f9f1749.js">
    <meta name="twitter:title" content="Proxy | 码步鱼">
    <meta property="og:title" content="Proxy | 码步鱼">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-6898e0ee><div class="sidebar-button" data-v-6898e0ee><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="码步鱼, back to home" data-v-6898e0ee data-v-7ac13a1e><!----> 码步鱼</a><div class="flex-grow" data-v-6898e0ee></div><div class="nav" data-v-6898e0ee><nav class="nav-links" data-v-6898e0ee data-v-640fc9fc><!--[--><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/" data-v-792310f6>首页 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/language/" data-v-792310f6>语言基础 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/article/" data-v-792310f6>文章 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item active" href="/open/" data-v-792310f6>OpenSource <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/micro/" data-v-792310f6>微服务 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/cloud/" data-v-792310f6>云 ☁️ <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/other/" data-v-792310f6>杂七杂八 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item isExternal" href="https://github.com/vbeats" target="_blank" rel="noopener noreferrer" data-v-792310f6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-792310f6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-71f182b0><nav class="nav-links nav" data-v-71f182b0 data-v-640fc9fc><!--[--><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/" data-v-792310f6>首页 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/language/" data-v-792310f6>语言基础 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/article/" data-v-792310f6>文章 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item active" href="/open/" data-v-792310f6>OpenSource <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/micro/" data-v-792310f6>微服务 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/cloud/" data-v-792310f6>云 ☁️ <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item" href="/other/" data-v-792310f6>杂七杂八 <!----></a></div></div><div class="item" data-v-640fc9fc><div class="nav-link" data-v-640fc9fc data-v-792310f6><a class="item isExternal" href="https://github.com/vbeats" target="_blank" rel="noopener noreferrer" data-v-792310f6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-792310f6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-71f182b0><!--[--><li class="sidebar-link"><p class="sidebar-link-item">开源项目/组件</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/open/index">文档</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/hadoop">hadoop</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/hdfs">hdfs</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/mapreduce">mapreduce</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/elk">elk</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/kafka">kafka</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/netty">netty</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/open/proxy">proxy</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#haproxy">HaProxy</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#keepalived">Keepalived</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/mysql">mysql</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/open/kong">kong</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h1 id="proxy"><a class="header-anchor" href="#proxy" aria-hidden="true">#</a> Proxy</h1><p>代理 负载均衡</p><h2 id="haproxy"><a class="header-anchor" href="#haproxy" aria-hidden="true">#</a> HaProxy</h2><p>支持 TCP HTTP <code>global</code>: haproxy 运行相关的全局配置 <code>defaults</code>: 默认参数配置 <code>listen</code>: 监听配置 <code>frontend</code>: 处理客户端请求, 按照规则分发请求 <code>backend</code>: 后端集群配置</p><div class="language-bash"><pre><code><span class="token comment"># 配置文件</span>
<span class="token comment"># 全局配置</span>
global
    <span class="token comment"># 启用每个实例日志记录事件和流量。</span>
    log global
    <span class="token comment"># 设置日志文件输出定向</span>
    log <span class="token number">127.0</span>.0.1 local3 info
    <span class="token comment"># 需要开启rsyslog</span>
    <span class="token comment"># vim /etc/rsyslog.conf</span>
    <span class="token comment"># 添加local3.* /var/log/haproxy.log</span>

    <span class="token comment"># 改变当前工作目录</span>
    <span class="token function">chroot</span> /usr/local/haproxy

    <span class="token comment"># 用户与用户组</span>
    user haproxy
    group haproxy

    <span class="token comment"># 守护进程启动，运维方式为后台工作</span>
    daemon

    <span class="token comment"># 最大连接数</span>
    maxconn <span class="token number">4000</span>

<span class="token comment"># 作用于其后紧跟的listen块，直至下一个defaults 块，下一个default 将替换上一个块作用于以后的listen</span>
defaults

    <span class="token comment"># 默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK</span>
    mode http

    <span class="token comment"># maxconn 65535         maxconn 每个进程可用的最大连接数</span>
    <span class="token comment"># retries 3         当对server的connection失败后，重试的次数 　</span>
    <span class="token comment"># option abortonclose     启用或禁用在队列中挂起的中止请求的早期丢弃</span>
    <span class="token comment"># option redispatch     启用或禁用在连接故障情况下的会话重新分配</span>
    <span class="token comment"># option dontlognull     启用和禁用 记录 空连接</span>
    <span class="token comment"># option httpclose         每次请求完毕后主动关闭http通道，HA-Proxy不支持keep-alive模式</span>
    <span class="token comment"># option forwardfor     获得客户端IP</span>
    <span class="token comment"># option httplog        记录HTTP 请求,session 状态和计时器</span>
    option httplog
    option dontlognull
    <span class="token function">timeout</span> connect <span class="token number">5000</span>
    <span class="token function">timeout</span> client <span class="token number">50000</span>
    <span class="token function">timeout</span> server <span class="token number">50000</span>


<span class="token comment">#前端配置，http_front名称可自定义</span>
frontend http_front

    <span class="token comment"># bind *:443 ssl crt /etc/haproxy/cert.pem        启用ssl证书</span>
    <span class="token comment"># bind *:80                        发起http请求道80端口，会被转发到设置的ip及端口</span>
    <span class="token builtin class-name">bind</span> *:80

    stats <span class="token builtin class-name">enable</span>
    <span class="token comment">#haproxy的状态管理页面，通过/haproxy?stats来访问</span>
    stats uri /haproxy?stats
    <span class="token comment"># stats auth &lt;user&gt;:&lt;passwd&gt;</span>
    default_backend http_back

<span class="token comment">#后端配置，http_back名称可自定义</span>
backend http_back

    <span class="token comment"># 负载均衡方式</span>
    <span class="token comment"># source 根据请求源IP</span>
    <span class="token comment"># static-rr 根据权重</span>
    <span class="token comment"># leastconn 最少连接者先处理</span>
    <span class="token comment"># uri 根据请求的uri</span>
    <span class="token comment"># url_param 根据请求的url参数</span>
    <span class="token comment"># rdp-cookie 据据cookie(name)来锁定并哈希每一次请求</span>
    <span class="token comment"># hdr(name) 根据HTTP请求头来锁定每一次HTTP请求</span>
    <span class="token comment"># roundrobin 轮询方式</span>
    balance roundrobin

    <span class="token comment">#设置健康检查页面</span>
    option httpchk GET /index.html

    <span class="token comment">#传递客户端真实IP</span>
    option forwardfor header X-Forwarded-For

    <span class="token comment"># inter 2000 健康检查时间间隔2秒</span>
    <span class="token comment"># rise 3 检测多少次才认为是正常的</span>
    <span class="token comment"># fall 3 失败多少次才认为是不可用的</span>
    <span class="token comment"># weight 30 权重</span>
    <span class="token comment"># 需要转发的ip及端口</span>
    <span class="token comment"># server &lt;name&gt; &lt;address&gt;[:port] [settings ...]</span>
    <span class="token comment"># default-server [settings ...]</span>
    server node1 xxxxx:8081 check inter <span class="token number">2000</span> rise <span class="token number">3</span> fall <span class="token number">3</span> weight <span class="token number">30</span>
    server node2 xxxxx:8082 check inter <span class="token number">2000</span> rise <span class="token number">3</span> fall <span class="token number">3</span> weight <span class="token number">30</span>

    <span class="token comment"># server first  10.1.1.1:1080 cookie first  check inter 1000</span>
    <span class="token comment"># server second 10.1.1.2:1080 cookie second check inter 1000</span>
    <span class="token comment"># server transp ipv4@</span>
    <span class="token comment"># server backup &quot;${SRV_BACKUP}:1080&quot; backup</span>
    <span class="token comment"># server www1_dc1 &quot;${LAN_DC1}.101:80&quot;</span>
    <span class="token comment"># server www1_dc2 &quot;${LAN_DC2}.101:80&quot;</span>

<span class="token comment"># haproxy的acl访问控制</span>
frontend http_front
    <span class="token builtin class-name">bind</span> *:80
    stats uri /haproxy?stats

    <span class="token comment">#创建一个acl，is_http_back2是acl的名称，可自定义，用于判断主机名是否为www.back2.com</span>
    acl is_http_back2 hdr_end<span class="token punctuation">(</span>host<span class="token punctuation">)</span> www.back2.com

    <span class="token comment">#通过正则判断主机名中是否为bbs.back.com或forum.back.com</span>
    acl is_host_bbs hdr_reg<span class="token punctuation">(</span>host<span class="token punctuation">)</span> -i ^<span class="token punctuation">(</span>bbs.back.com<span class="token operator">|</span>forum.back.com<span class="token punctuation">)</span>

    <span class="token comment">#判断ua是否为android</span>
    acl is_ua_android hdr_reg<span class="token punctuation">(</span>User-Agent<span class="token punctuation">)</span> -i android

    <span class="token comment">#判断主机名开头是否为img.或css.或js.</span>
    acl is_host_static hdr_beg<span class="token punctuation">(</span>host<span class="token punctuation">)</span> -i img. css. js.

    <span class="token comment">#判断url路径中是否有/bbs</span>
    acl is_path_bbs path_beg -i /bbs

    <span class="token comment">#判断url文件结尾</span>
    acl is_php path_end -i .php

    <span class="token comment">#通过正则判断url中结尾以</span>
    acl is_static_file url_reg -i /*.<span class="token punctuation">(</span>css<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>jpeg<span class="token operator">|</span>gif<span class="token punctuation">)</span>$

    <span class="token comment">#效果同上</span>
    acl is_static_file2 path_end -i .css .jpg .png .jpeg .gif

    <span class="token comment">#如果主机名是www.back2.com那么就使用后端http_back2</span>
    <span class="token comment"># use_backend &lt;backend&gt; [{if | unless} &lt;condition&gt;]</span>
    use_backend http_back2 <span class="token keyword">if</span> is_http_back2 or is_ua_android

    <span class="token comment">#默认使用的后端</span>
    default_backend http_back

backend http_back
    balance roundrobin
    option httpchk GET /index.html
    option forwardfor header X-Forwarded-For
    server node1 <span class="token number">192.168</span>.1.222:8080 check inter <span class="token number">2000</span> rise <span class="token number">3</span> fall <span class="token number">3</span> weight <span class="token number">30</span>

backend http_back2
    balance roundrobin
    option httpchk GET /index.html
    option forwardfor header X-Forwarded-For
    server node2 <span class="token number">192.168</span>.1.222:8082 check inter <span class="token number">2000</span> rise <span class="token number">3</span> fall <span class="token number">3</span> weight <span class="token number">30</span>
</code></pre></div><p><code>log</code> 格式:</p><div class="language-bash"><pre><code>log-format %T<span class="token punctuation">\</span> %t<span class="token punctuation">\</span> Some<span class="token punctuation">\</span> Text
log-format %<span class="token punctuation">{</span>+Q<span class="token punctuation">}</span>o<span class="token punctuation">\</span> %t<span class="token punctuation">\</span> %s<span class="token punctuation">\</span> %<span class="token punctuation">{</span>-Q<span class="token punctuation">}</span>r

log-format-sd %<span class="token punctuation">{</span>+Q,+E<span class="token punctuation">}</span>o<span class="token punctuation">\</span> <span class="token punctuation">[</span>exampleSDID@1234<span class="token punctuation">\</span> <span class="token assign-left variable">header</span><span class="token operator">=</span>%<span class="token punctuation">[</span>capture.req.hdr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

+---+------+-----------------------------------------------+-------------+
  <span class="token operator">|</span> R <span class="token operator">|</span> var  <span class="token operator">|</span> field name <span class="token punctuation">(</span><span class="token number">8.2</span>.2 and <span class="token number">8.2</span>.3 <span class="token keyword">for</span> description<span class="token punctuation">)</span>  <span class="token operator">|</span> <span class="token builtin class-name">type</span>        <span class="token operator">|</span>
  +---+------+-----------------------------------------------+-------------+
  <span class="token operator">|</span>   <span class="token operator">|</span> %o   <span class="token operator">|</span> special variable, apply flags on all next var <span class="token operator">|</span>             <span class="token operator">|</span>
  +---+------+-----------------------------------------------+-------------+
  <span class="token operator">|</span>   <span class="token operator">|</span> %B   <span class="token operator">|</span> bytes_read           <span class="token punctuation">(</span>from server to client<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %CC  <span class="token operator">|</span> captured_request_cookie                       <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %CS  <span class="token operator">|</span> captured_response_cookie                      <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %H   <span class="token operator">|</span> <span class="token function">hostname</span>                                      <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %HM  <span class="token operator">|</span> HTTP method <span class="token punctuation">(</span>ex: POST<span class="token punctuation">)</span>                        <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %HP  <span class="token operator">|</span> HTTP request URI without query string <span class="token punctuation">(</span>path<span class="token punctuation">)</span>  <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %HQ  <span class="token operator">|</span> HTTP request URI query string <span class="token punctuation">(</span>ex: ?bar<span class="token operator">=</span>baz<span class="token punctuation">)</span>  <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %HU  <span class="token operator">|</span> HTTP request URI <span class="token punctuation">(</span>ex: /foo?bar<span class="token operator">=</span>baz<span class="token punctuation">)</span>           <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %HV  <span class="token operator">|</span> HTTP version <span class="token punctuation">(</span>ex: HTTP/1.0<span class="token punctuation">)</span>                   <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ID  <span class="token operator">|</span> unique-id                                     <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ST  <span class="token operator">|</span> status_code                                   <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %T   <span class="token operator">|</span> gmt_date_time                                 <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Ta  <span class="token operator">|</span> Active <span class="token function">time</span> of the request <span class="token punctuation">(</span>from TR to end<span class="token punctuation">)</span>   <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Tc  <span class="token operator">|</span> Tc                                            <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Td  <span class="token operator">|</span> Td <span class="token operator">=</span> Tt - <span class="token punctuation">(</span>Tq + Tw + Tc + Tr<span class="token punctuation">)</span>                 <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Tl  <span class="token operator">|</span> local_date_time                               <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Th  <span class="token operator">|</span> connection handshake <span class="token function">time</span> <span class="token punctuation">(</span>SSL, PROXY proto<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %Ti  <span class="token operator">|</span> idle <span class="token function">time</span> before the HTTP request             <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %Tq  <span class="token operator">|</span> Th + Ti + TR                                  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %TR  <span class="token operator">|</span> <span class="token function">time</span> to receive the full request from 1st byte<span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %Tr  <span class="token operator">|</span> Tr <span class="token punctuation">(</span>response <span class="token function">time</span><span class="token punctuation">)</span>                            <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Ts  <span class="token operator">|</span> timestamp                                     <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Tt  <span class="token operator">|</span> Tt                                            <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %Tw  <span class="token operator">|</span> Tw                                            <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %U   <span class="token operator">|</span> bytes_uploaded       <span class="token punctuation">(</span>from client to server<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ac  <span class="token operator">|</span> actconn                                       <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %b   <span class="token operator">|</span> backend_name                                  <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %bc  <span class="token operator">|</span> beconn      <span class="token punctuation">(</span>backend concurrent connections<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %bi  <span class="token operator">|</span> backend_source_ip       <span class="token punctuation">(</span>connecting address<span class="token punctuation">)</span>  <span class="token operator">|</span> IP          <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %bp  <span class="token operator">|</span> backend_source_port     <span class="token punctuation">(</span>connecting address<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %bq  <span class="token operator">|</span> backend_queue                                 <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ci  <span class="token operator">|</span> client_ip                 <span class="token punctuation">(</span>accepted address<span class="token punctuation">)</span>  <span class="token operator">|</span> IP          <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %cp  <span class="token operator">|</span> client_port               <span class="token punctuation">(</span>accepted address<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %f   <span class="token operator">|</span> frontend_name                                 <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %fc  <span class="token operator">|</span> feconn     <span class="token punctuation">(</span>frontend concurrent connections<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %fi  <span class="token operator">|</span> frontend_ip              <span class="token punctuation">(</span>accepting address<span class="token punctuation">)</span>  <span class="token operator">|</span> IP          <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %fp  <span class="token operator">|</span> frontend_port            <span class="token punctuation">(</span>accepting address<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ft  <span class="token operator">|</span> frontend_name_transport <span class="token punctuation">(</span><span class="token string">&#39;~&#39;</span> suffix <span class="token keyword">for</span> SSL<span class="token punctuation">)</span>  <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %lc  <span class="token operator">|</span> frontend_log_counter                          <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %hr  <span class="token operator">|</span> captured_request_headers default style        <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %hrl <span class="token operator">|</span> captured_request_headers CLF style            <span class="token operator">|</span> string list <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %hs  <span class="token operator">|</span> captured_response_headers default style       <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %hsl <span class="token operator">|</span> captured_response_headers CLF style           <span class="token operator">|</span> string list <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ms  <span class="token operator">|</span> accept <span class="token function">date</span> milliseconds <span class="token punctuation">(</span>left-padded with <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %pid <span class="token operator">|</span> PID                                           <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %r   <span class="token operator">|</span> http_request                                  <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %rc  <span class="token operator">|</span> retries                                       <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %rt  <span class="token operator">|</span> request_counter <span class="token punctuation">(</span>HTTP req or TCP session<span class="token punctuation">)</span>     <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %s   <span class="token operator">|</span> server_name                                   <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %sc  <span class="token operator">|</span> srv_conn     <span class="token punctuation">(</span>server concurrent connections<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %si  <span class="token operator">|</span> server_IP                   <span class="token punctuation">(</span>target address<span class="token punctuation">)</span>  <span class="token operator">|</span> IP          <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %sp  <span class="token operator">|</span> server_port                 <span class="token punctuation">(</span>target address<span class="token punctuation">)</span>  <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %sq  <span class="token operator">|</span> srv_queue                                     <span class="token operator">|</span> numeric     <span class="token operator">|</span>
  <span class="token operator">|</span> S <span class="token operator">|</span> %sslc<span class="token operator">|</span> ssl_ciphers <span class="token punctuation">(</span>ex: AES-SHA<span class="token punctuation">)</span>                     <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> S <span class="token operator">|</span> %sslv<span class="token operator">|</span> ssl_version <span class="token punctuation">(</span>ex: TLSv1<span class="token punctuation">)</span>                       <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %t   <span class="token operator">|</span> date_time      <span class="token punctuation">(</span>with millisecond resolution<span class="token punctuation">)</span>  <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %tr  <span class="token operator">|</span> date_time of HTTP request                     <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %trg <span class="token operator">|</span> gmt_date_time of start of HTTP request        <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %trl <span class="token operator">|</span> local_date_time of start of HTTP request      <span class="token operator">|</span> <span class="token function">date</span>        <span class="token operator">|</span>
  <span class="token operator">|</span>   <span class="token operator">|</span> %ts  <span class="token operator">|</span> termination_state                             <span class="token operator">|</span> string      <span class="token operator">|</span>
  <span class="token operator">|</span> H <span class="token operator">|</span> %tsc <span class="token operator">|</span> termination_state with cookie status          <span class="token operator">|</span> string      <span class="token operator">|</span>
  +---+------+-----------------------------------------------+-------------+
</code></pre></div><p>错误页面重定向:</p><div class="language-bash"><pre><code><span class="token comment"># 200, 400, 403, 405, 408, 425, 429, 500, 502, 503, and 504 不支持404</span>
errorloc <span class="token operator">&lt;</span>code<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>url<span class="token operator">&gt;</span>
errorloc302 <span class="token operator">&lt;</span>code<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>url<span class="token operator">&gt;</span>

errorfile <span class="token operator">&lt;</span>code<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>
</code></pre></div><h2 id="keepalived"><a class="header-anchor" href="#keepalived" aria-hidden="true">#</a> Keepalived</h2><p><a href="https://www.keepalived.org/manpage.html" target="_blank" rel="noopener noreferrer">文档</a></p><p>故障转移 健康检查 <code>vrrp</code>协议, 竞选 master, master 发送广播, master 挂掉, 备用节点接管</p><div class="language-bash"><pre><code>global_refs<span class="token punctuation">{</span>
    <span class="token comment"># 节点路由唯一标识</span>
    router_id xxx
<span class="token punctuation">}</span>
<span class="token comment"># 主备节点要用同一个vrrp实例名</span>
vrrp_instance xx1<span class="token punctuation">{</span>
    <span class="token comment"># 备节点 BACKUP</span>
    state MASTER
    interface eth0
    <span class="token comment"># 0~255 用于区分vrrp实例</span>
    virtual_router_id <span class="token number">51</span>
    <span class="token comment"># 节点优先级  主备差50</span>
    priority <span class="token number">200</span>
    <span class="token comment"># 心跳间隔</span>
    advert_init <span class="token number">1</span>
    <span class="token comment"># 通信认证</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass xxxxxx
    <span class="token punctuation">}</span>

    <span class="token comment"># 虚拟ip</span>
    virtual_ipaddress<span class="token punctuation">{</span>
        xxxxx/24
        xxxxx/24
        xxxxx/24
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div><footer class="page-footer" data-v-8fcebc32 data-v-5c96fb00><div class="edit" data-v-5c96fb00><div class="edit-link" data-v-5c96fb00 data-v-55695e90><!----></div></div><div class="updated" data-v-5c96fb00><!----></div></footer><div class="next-and-prev-link" data-v-8fcebc32 data-v-e65a9748><div class="container" data-v-e65a9748><div class="prev" data-v-e65a9748><a class="link" href="/open/netty" data-v-e65a9748><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-e65a9748><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-e65a9748>netty</span></a></div><div class="next" data-v-e65a9748><a class="link" href="/open/mysql" data-v-e65a9748><span class="text" data-v-e65a9748>mysql</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-e65a9748><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"readme.md\":\"c17ac84b\",\"index.md\":\"7cb86a84\",\"article_index.md\":\"e93ae91b\",\"article_sts.md\":\"48332649\",\"cloud_index.md\":\"070ca839\",\"cloud_k8s.md\":\"a315e551\",\"cloud_rancher.md\":\"5e6dac4f\",\"language_canvas.md\":\"987f2343\",\"language_flink.md\":\"f23da271\",\"language_flutter.md\":\"f28cf49c\",\"language_index.md\":\"bd56f330\",\"language_jvm.md\":\"22b59bea\",\"language_kafka.md\":\"c9ccd70f\",\"language_mongo.md\":\"b893c348\",\"language_node.md\":\"c0c47ec0\",\"language_python.md\":\"e0486ed6\",\"language_react.md\":\"d55d683d\",\"language_redis.md\":\"0a583a77\",\"language_rocket.md\":\"fb9cb0aa\",\"language_socketio.md\":\"4d78b875\",\"language_typescript.md\":\"396c59c4\",\"language_webpack.md\":\"ca59d184\",\"language_zookeeper.md\":\"e1f3ddcf\",\"micro_index.md\":\"0a482675\",\"open_elk.md\":\"c56b23ef\",\"open_hadoop.md\":\"8090a50d\",\"open_hdfs.md\":\"8b8efd43\",\"open_index.md\":\"137550a6\",\"open_kong.md\":\"ecdb76d5\",\"open_mapreduce.md\":\"46f34a05\",\"open_mysql.md\":\"6bbc1d38\",\"open_netty.md\":\"5ac679ed\",\"open_proxy.md\":\"55480c0e\",\"other_index.md\":\"3bd80b6d\",\"other_linux.md\":\"903fc65f\",\"other_nginx.md\":\"5e0b57e3\",\"other_other.md\":\"2cd0edb2\",\"other_shell.md\":\"0f862476\",\"other_wireshark.md\":\"63aa9925\",\"other_xianyu.md\":\"a559b13e\"}")</script>
    <script type="module" async src="/assets/app.9f9f1749.js"></script>
  </body>
</html>