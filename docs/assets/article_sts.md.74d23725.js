import{o as n,c as s,a,b as t}from"./app.8862131a.js";const o='{"title":"sts 临时身份验证","description":"","frontmatter":{},"headers":[{"level":2,"title":"sts 临时身份验证","slug":"sts-临时身份验证"},{"level":3,"title":"案例 🦷","slug":"案例-🦷"}],"relativePath":"article/sts.md","lastUpdated":1629208208367}',e={},c=a("h2",{id:"sts-临时身份验证"},[a("a",{class:"header-anchor",href:"#sts-临时身份验证","aria-hidden":"true"},"#"),t(" sts 临时身份验证")],-1),p=a("h3",{id:"案例-🦷"},[a("a",{class:"header-anchor",href:"#案例-🦷","aria-hidden":"true"},"#"),t(" 案例 🦷")],-1),l=a("blockquote",null,[a("p",null,"客户端使用 STS 临时凭证访问云服务")],-1),u=a("p",null,[t("sts 全称 "),a("code",null,"security token service"),t(", 目前主流的云服务平台基本都支持, 下文主要以阿里云为案例讲解, aws 大同小异, 可以类比参考. sts 可以使客户端不暴露 accessKey 与 accessSecret 实现对云服务的直接安全请求调用, 减少与后端接口的交互与额外的流量消耗.")],-1),i=a("div",{class:"tip custom-block"},[a("p",{class:"custom-block-title"},"TIP"),a("p",null,[t("服务端生成 sts 临时 token 与 signature, 客户端直接基于 "),a("code",null,"sts token"),t("、"),a("code",null,"signature"),t(" 签名等必要的参数信息实现 OSS 文件上传.")])],-1),k=a("p",null,"使用 STS 授权用户直接访问 OSS 的流程如下： (图片来源 阿里云文档)",-1),r=a("p",null,[a("img",{src:"/assets/sts.528e516f.jpg",alt:"sts"})],-1),d=a("ol",null,[a("li",null,[a("p",null,[t("创建用于 sts 认证的"),a("code",null,"子用户"),t(", 复制下"),a("code",null,"子用户的 AccessKey ID 与 AccessKey Secret")])]),a("li",null,[a("p",null,[t("新建 "),a("code",null,"Ram"),t(" 角色, 分配 "),a("code",null,"AliyunSTSAssumeRoleAccess"),t(" 的系统策略权限, 同时新增权限策略, 添加对应云服务的策略, 以 oss 为例:")]),a("p",null,"具体策略配置方式查看文档, 或者通过生成器生成.")])],-1),m=a("div",{class:"language-json"},[a("pre",null,[a("code",null,[a("span",{class:"token punctuation"},"{"),t("\n  "),a("span",{class:"token property"},'"Version"'),a("span",{class:"token operator"},":"),t(),a("span",{class:"token string"},'"1"'),a("span",{class:"token punctuation"},","),t("\n  "),a("span",{class:"token property"},'"Statement"'),a("span",{class:"token operator"},":"),t(),a("span",{class:"token punctuation"},"["),t("\n    "),a("span",{class:"token punctuation"},"{"),t("\n      "),a("span",{class:"token property"},'"Effect"'),a("span",{class:"token operator"},":"),t(),a("span",{class:"token string"},'"Allow"'),a("span",{class:"token punctuation"},","),t("\n      "),a("span",{class:"token property"},'"Action"'),a("span",{class:"token operator"},":"),t(),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},'"oss:PutObject"'),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token string"},'"oss:GetObject"'),a("span",{class:"token punctuation"},"]"),a("span",{class:"token punctuation"},","),t("\n      "),a("span",{class:"token property"},'"Resource"'),a("span",{class:"token operator"},":"),t(),a("span",{class:"token punctuation"},"["),a("span",{class:"token string"},'"acs:oss:*:*:xx-bucket/oo"'),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token string"},'"acs:oss:*:*:xx-bucket/oo/*"'),a("span",{class:"token punctuation"},"]"),t("\n    "),a("span",{class:"token punctuation"},"}"),t("\n  "),a("span",{class:"token punctuation"},"]"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),g=a("ol",{start:"3"},[a("li",null,[a("p",null,[t("复制下 "),a("code",null,"Ram"),t(" 角色的 "),a("code",null,"ARN"),t(" 字段值, 也可以修改"),a("code",null,"最大会话时间"),t(".")])]),a("li",null,[a("p",null,[t("账号相关权限分配结束, 下面开始写服务端代码, 生成 "),a("code",null,"sts token"),t("、signature "),a("code",null,"、"),t("policy` 等信息.")])])],-1),y=a("p",null,[t("接口调用也可以用 "),a("code",null,"OpenAPI Explorer"),t(" 调试请求")],-1),f=a("p",null,"以 java 代码为例(基于旧 sdk):",-1),S=a("div",{class:"language-java"},[a("pre",null,[a("code",null,[a("span",{class:"token comment"},"// STS接入地址，例如sts.cn-hangzhou.aliyuncs.com。"),t("\n"),a("span",{class:"token class-name"},"String"),t(" regionId "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'""'),a("span",{class:"token punctuation"},";"),t("\n"),a("span",{class:"token comment"},"// 填写步骤1生成的访问密钥AccessKey ID和AccessKey Secret。"),t("\n"),a("span",{class:"token class-name"},"String"),t(" accessKeyId "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'"xxxxxxxxxx"'),a("span",{class:"token punctuation"},";"),t("\n"),a("span",{class:"token class-name"},"String"),t(" accessKeySecret "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'"ooooooooooo"'),a("span",{class:"token punctuation"},";"),t("\n"),a("span",{class:"token class-name"},"String"),t(" endPoint "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'"....."'),a("span",{class:"token punctuation"},";"),t("  "),a("span",{class:"token comment"},"// oss bucket endpoint"),t("\n"),a("span",{class:"token comment"},"// 填写步骤3获取的角色ARN。"),t("\n"),a("span",{class:"token class-name"},"String"),t(" roleArn "),a("span",{class:"token operator"},"="),t(" appConfig"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getAliArn"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n"),a("span",{class:"token comment"},"// 自定义角色会话名称，用来区分不同的令牌，例如可填写为SessionTest。"),t("\n"),a("span",{class:"token class-name"},"String"),t(" roleSessionName "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'"xxTest"'),a("span",{class:"token punctuation"},";"),t("\n\n"),a("span",{class:"token class-name"},"String"),t(" path "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token string"},'"oo"'),a("span",{class:"token punctuation"},";"),t(),a("span",{class:"token comment"},"// oss bucket 内文件子路径"),t("\n"),a("span",{class:"token class-name"},"Long"),t(" maxFileSize "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token number"},"10"),t(" _ "),a("span",{class:"token number"},"1024"),t(" _ "),a("span",{class:"token number"},"1024L"),a("span",{class:"token punctuation"},";"),t(),a("span",{class:"token comment"},"// 最大 10M"),t("\n"),a("span",{class:"token comment"},"// 1 小时有效"),t("\n"),a("span",{class:"token class-name"},"OffsetDateTime"),t(" expires "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token class-name"},"LocalDateTime"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"now"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"plusHours"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"1L"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"atOffset"),a("span",{class:"token punctuation"},"("),a("span",{class:"token class-name"},"ZoneOffset"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"of"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},'"+8"'),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n​\n"),a("span",{class:"token keyword"},"try"),t(),a("span",{class:"token punctuation"},"{"),t("\n    "),a("span",{class:"token comment"},"// sts token"),t("\n    ​\n    "),a("span",{class:"token comment"},"// 构造 profile。"),t("\n    "),a("span",{class:"token class-name"},"IClientProfile"),t(" profile "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token class-name"},"DefaultProfile"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getProfile"),a("span",{class:"token punctuation"},"("),t("regionId"),a("span",{class:"token punctuation"},","),t(" accessKeyId"),a("span",{class:"token punctuation"},","),t(" accessKeySecret"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    "),a("span",{class:"token comment"},"// 构造 client。"),t("\n    "),a("span",{class:"token class-name"},"DefaultAcsClient"),t(" client "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"DefaultAcsClient"),a("span",{class:"token punctuation"},"("),t("profile"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    "),a("span",{class:"token keyword"},"final"),t(),a("span",{class:"token class-name"},"AssumeRoleRequest"),t(" request "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"AssumeRoleRequest"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    request"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"setRoleArn"),a("span",{class:"token punctuation"},"("),t("roleArn"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    request"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"setRoleSessionName"),a("span",{class:"token punctuation"},"("),t("roleSessionName"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    request"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"setDurationSeconds"),a("span",{class:"token punctuation"},"("),a("span",{class:"token number"},"3600L"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t(),a("span",{class:"token comment"},"// 设置临时访问凭证的有效时间为 3600 秒。"),t("\n    ​\n    "),a("span",{class:"token class-name"},"AssumeRoleResponse"),t(" response "),a("span",{class:"token operator"},"="),t(" client"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getAcsResponse"),a("span",{class:"token punctuation"},"("),t("request"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    "),a("span",{class:"token class-name"},[t("AssumeRoleResponse"),a("span",{class:"token punctuation"},"."),t("Credentials")]),t(" credentials "),a("span",{class:"token operator"},"="),t(" response"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getCredentials"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    "),a("span",{class:"token class-name"},"String"),t(" stsToken "),a("span",{class:"token operator"},"="),t(" credentials"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getSecurityToken"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    ​\n    "),a("span",{class:"token comment"},"// 签名"),t("\n    "),a("span",{class:"token class-name"},"OSS"),t(" ossClient "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"OSSClientBuilder"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"build"),a("span",{class:"token punctuation"},"("),t("endPoint"),a("span",{class:"token punctuation"},","),t(" credentials"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getAccessKeyId"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),t(" credentials"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getAccessKeySecret"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),t(" stsToken"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    ​\n    "),a("span",{class:"token comment"},"// policy 策略, 进一步限定权限"),t("\n    "),a("span",{class:"token comment"},"// 临时访问凭证最后获得的权限是步骤 4 设置的角色权限和该 Policy 设置权限的交集，"),t("\n    "),a("span",{class:"token class-name"},"PolicyConditions"),t(" policyConditions "),a("span",{class:"token operator"},"="),t(),a("span",{class:"token keyword"},"new"),t(),a("span",{class:"token class-name"},"PolicyConditions"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    policyConditions"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"addConditionItem"),a("span",{class:"token punctuation"},"("),a("span",{class:"token class-name"},"PolicyConditions"),a("span",{class:"token punctuation"},"."),t("COND_CONTENT_LENGTH_RANGE"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token number"},"0"),a("span",{class:"token punctuation"},","),t(" maxFileSize"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    ​\n    "),a("span",{class:"token class-name"},"String"),t(" policy "),a("span",{class:"token operator"},"="),t(" ossClient"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"generatePostPolicy"),a("span",{class:"token punctuation"},"("),a("span",{class:"token class-name"},"Date"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"from"),a("span",{class:"token punctuation"},"("),t("expires"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"toInstant"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),t(" policyConditions"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    "),a("span",{class:"token class-name"},"String"),t(" signature "),a("span",{class:"token operator"},"="),t(" ossClient"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"calculatePostSignature"),a("span",{class:"token punctuation"},"("),t("policy"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n    ​\n    log"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"info"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},'"endpoint: {},policy: {},signature: {}, path: {}, accessKeyId: {}, sts_token: {}"'),a("span",{class:"token punctuation"},","),t("endPoint"),a("span",{class:"token punctuation"},","),t(),a("span",{class:"token class-name"},"Base64Utils"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"encodeToString"),a("span",{class:"token punctuation"},"("),t("policy"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getByte"),a("span",{class:"token punctuation"},"("),a("span",{class:"token class-name"},"StandardCharsets"),a("span",{class:"token punctuation"},"."),t("UTF_8"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),t("\n    signature"),a("span",{class:"token punctuation"},","),t(" path"),a("span",{class:"token punctuation"},","),t(" credentials"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"getAccessKeyId"),a("span",{class:"token punctuation"},"("),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},","),t(" stsToken"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),a("span",{class:"token punctuation"},")"),t("\n"),a("span",{class:"token punctuation"},"}"),t(),a("span",{class:"token keyword"},"catch"),t(),a("span",{class:"token punctuation"},"("),a("span",{class:"token class-name"},"ClientException"),t(" e"),a("span",{class:"token punctuation"},")"),t(),a("span",{class:"token punctuation"},"{"),t("\n    log"),a("span",{class:"token punctuation"},"."),a("span",{class:"token function"},"error"),a("span",{class:"token punctuation"},"("),a("span",{class:"token string"},'"获取 sts token 失败"'),a("span",{class:"token punctuation"},","),t(" e"),a("span",{class:"token punctuation"},")"),a("span",{class:"token punctuation"},";"),t("\n"),a("span",{class:"token punctuation"},"}"),t("\n")])])],-1),A=a("div",{class:"warning custom-block"},[a("p",{class:"custom-block-title"},"WARNING"),a("p",null,[t("注意: 生成客户端参数 "),a("code",null,"signature"),t(" 时, 基于的是生成 "),a("code",null,"sts"),t(" 时返回的"),a("code",null,"临时 AccessKeyId"),t(" 和"),a("code",null,"临时的 AccessKeySecret"),t(", 包括最后客户端发起 http 请求使用的也是与 sts 对应返回的"),a("code",null,"临时 AccessKeyId"),t(", 而不是一开始创建的"),a("code",null,"子用户 id"),t(".")])],-1),x=a("p",null,[t("权限方面, 一定是 "),a("code",null,"Ram"),t(" 角色权限、"),a("code",null,"policy"),t("、"),a("code",null,"bucket"),t(" 权限的最小交集. 注意不要搞的太复杂啰嗦把自己带沟里.")],-1),b=a("ol",{start:"5"},[a("li",null,"客户端(web、app、小程序、postman 等等)拿到 sts token、signature、policy、临时的 accessKeyId 等信息就可以直接发起 post 请求向 oss 上传文件了.")],-1),h=a("div",{class:"language-bash"},[a("pre",null,[a("code",null,[t("url: bucket endpoint\n\n请求方式: post/form-data\n\n参数:\nkey: 上传后的文件路径+文件名\npolicy: policy json 字符串"),a("span",{class:"token punctuation"},"("),t("base64"),a("span",{class:"token punctuation"},")"),t("\nOSSAccessKeyId: 临时的 accessKeyId\nsignature: 基于临时 accessKeyId accessKeySecret 计算的签名\nx-oss-security-token: sts token\nfile: 要上传的文件\n")])])],-1),C=a("p",null,"总结: 基于 sts 客户端文件上传 oss, 节省了服务端的带宽流量, 安全可靠, 不止 oss 服务, 绝大多数云服务也都可以基于 sts 的方式请求, 具体可以结合项目情况灵活选择.",-1);e.render=function(a,t,o,e,I,K){return n(),s("div",null,[c,p,l,u,i,k,r,d,m,g,y,f,S,A,x,b,h,C])};export default e;export{o as __pageData};
