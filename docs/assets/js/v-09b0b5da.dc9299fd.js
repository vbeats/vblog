"use strict";(self.webpackChunkvblog=self.webpackChunkvblog||[]).push([[203],{7983:(s,n,a)=>{a.r(n),a.d(n,{data:()=>e});const e={key:"v-09b0b5da",path:"/cloud/base/rancher.html",title:"Rancher 🐄",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"高可用部署(k3s)",slug:"高可用部署-k3s",children:[]}],filePathRelative:"cloud/base/rancher.md",git:{updatedTime:1636376439e3,contributors:[{name:"bootvue",email:"bootvue@gmail.com",commits:1}]}}},9933:(s,n,a)=>{a.r(n),a.d(n,{default:()=>o});var e=a(6252);const p=(0,e._)("h1",{id:"rancher-🐄",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#rancher-🐄","aria-hidden":"true"},"#"),(0,e.Uk)(" Rancher 🐄")],-1),t={href:"https://docs.rancher.cn/rancher2/",target:"_blank",rel:"noopener noreferrer"},r=(0,e.Uk)("文档"),l=(0,e.uE)('<h2 id="高可用部署-k3s" tabindex="-1"><a class="header-anchor" href="#高可用部署-k3s" aria-hidden="true">#</a> 高可用部署(k3s)</h2><table><thead><tr><th>ip</th><th>role</th></tr></thead><tbody><tr><td>192.168.100.80</td><td>demo.com,数据库,nginx</td></tr><tr><td>192.168.100.81</td><td>k3s server,rancher server</td></tr><tr><td>192.168.100.82</td><td>k3s server,rancher server</td></tr></tbody></table><blockquote><p>server 节点安装 kubectl k3s helm 工具</p></blockquote><ol><li>k3s 集群</li></ol><p>k3s server 节点也同时作为 agent 节点部署 rancher</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -sfL https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> -s - server <span class="token punctuation">\\</span>\n  --datastore-endpoint<span class="token operator">=</span><span class="token string">&quot;mysql://username:password@tcp(hostname:3306)/database-name&quot;</span>\n\n\nk3s kubectl get nodes\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>保存<code>kubeconfig</code>文件</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cp</span> /etc/rancher/k3s/k3s.yaml ~/.kube/config\n\n\nkubectl get pods --all-namespaces\n\n<span class="token comment"># 创建rancher的namespace</span>\nkubectl create namespace cattle-system\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>负载均衡器</li></ol><p><code>7层代理</code> tls 在 rancher server/k3s 集群内 ingress 终止</p><div class="language-nginx ext-nginx line-numbers-mode"><pre class="language-nginx"><code>    <span class="token directive"><span class="token keyword">upstream</span> rancher</span> <span class="token punctuation">{</span>\n        <span class="token directive"><span class="token keyword">server</span> 192.168.100.81:80</span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">server</span> 192.168.100.82:80</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span></span> <span class="token punctuation">{</span>\n        <span class="token directive"><span class="token keyword">default</span> Upgrade</span><span class="token punctuation">;</span>\n        &#39;&#39; <span class="token directive"><span class="token keyword">close</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>\n        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl http2</span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">server_name</span> demo.com</span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">ssl_certificate</span> /root/demo.com.crt</span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /root/demo.com.key</span><span class="token punctuation">;</span>\n\n        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token variable">$server_port</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_pass</span> http://rancher</span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>\n            <span class="token comment"># This allows the ability for the execute shell window to remain open for up to 15 minutes. Without this parameter, the default is 1 minute and will automatically close.</span>\n            <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">900s</span></span><span class="token punctuation">;</span>\n            <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>\n        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">server_name</span> demo.com</span><span class="token punctuation">;</span>\n        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$server_name</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ol start="3"><li>helm 安装 rancher server</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>helm repo <span class="token function">add</span> rancher-stable https://releases.rancher.com/server-charts/stable\n\n<span class="token comment"># k8s secret添加ssl证书</span>\n\nkubectl -n cattle-system create secret tls tls-rancher-ingress <span class="token punctuation">\\</span>\n  --cert<span class="token operator">=</span>tls.pem <span class="token punctuation">\\</span>\n  --key<span class="token operator">=</span>tls.key\n\n<span class="token comment"># tls认证</span>\nhelm <span class="token function">install</span> rancher rancher-stable/rancher <span class="token punctuation">\\</span>\n  --namespace cattle-system <span class="token punctuation">\\</span>\n  --set <span class="token assign-left variable">hostname</span><span class="token operator">=</span>demo.com <span class="token punctuation">\\</span>\n  --set ingress.tls.source<span class="token operator">=</span>secret <span class="token punctuation">\\</span>\n  --set <span class="token assign-left variable">privateCA</span><span class="token operator">=</span>true <span class="token punctuation">\\</span>\n  --set <span class="token assign-left variable">tls</span><span class="token operator">=</span>ingress <span class="token punctuation">\\</span>\n  --set <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token number">2</span>\n\n\n<span class="token comment"># tls验证</span>\n\nopenssl s_client -connect demo.com:443 -servername demo.com <span class="token comment"># -CAfile ca.crt</span>\n\n<span class="token comment"># 查看安装</span>\nkubectl -n cattle-system rollout status deploy/rancher\n\nkubectl -n cattle-system get deploy rancher\n\nkubectl get pods -n cattle-system\n\nkubectl describe pod xxxxx -n cattle-system\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div>',13),c={},o=(0,a(3744).Z)(c,[["render",function(s,n){const a=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.iD)(e.HY,null,[p,(0,e._)("p",null,[(0,e._)("a",t,[r,(0,e.Wm)(a)])]),l],64)}]])},3744:(s,n)=>{n.Z=(s,n)=>{for(const[a,e]of n)s[a]=e;return s}}}]);